<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Your Wonderland Cards</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#070b10; --bg2:#0a1321; --panel:#0d1623; --ink:#0b1220;
    --ring: rgba(255,255,255,.12); --ring2: rgba(255,255,255,.08);
    --text:#e8f0ff; --muted:#9db0c8; --accent:#00C2C7; --accent2:#7dd3fc;
    --c-common:#8ab4f8; --c-rare:#7dd3fc; --c-epic:#c084fc; --c-legend:#fbbf24;
  }
  *{ box-sizing:border-box; }

  body{
    margin:0;
    color:var(--text);
    font-family:Outfit, ui-sans-serif, system-ui, Segoe UI, Roboto, Arial;
    background:
      radial-gradient(1200px 800px at -10% -10%, #081628 0%, transparent 60%),
      radial-gradient(900px 600px at 110% 20%, #041a1b 0%, transparent 55%),
      linear-gradient(180deg, var(--bg) 0%, var(--bg2) 100%);
    min-height:100dvh;
  }

  /* Floating sparkles backdrop */
  .stars{ position:fixed; inset:0; pointer-events:none; z-index:0; opacity:.25; }
  .stars:before, .stars:after{
    content:""; position:absolute; inset:-20%;
    background:
      radial-gradient(2px 2px at 10% 20%, #fff 0 30%, transparent 60%),
      radial-gradient(2px 2px at 80% 15%, #fff 0 30%, transparent 60%),
      radial-gradient(2px 2px at 40% 70%, #fff 0 30%, transparent 60%),
      radial-gradient(2px 2px at 65% 50%, #fff 0 30%, transparent 60%),
      radial-gradient(2px 2px at 20% 90%, #fff 0 30%, transparent 60%);
    animation: drift 40s linear infinite;
    filter: blur(.4px);
  }
  .stars:after{ animation-duration:64s; opacity:.7 }
  @keyframes drift{ from{ transform:translateY(0) } to{ transform:translateY(-10%) } }

  .wrap{ position:relative; z-index:1; max-width:1200px; margin:0 auto; padding:20px; }

  /* HERO */
  .hero{
    display:flex; gap:16px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    background:linear-gradient(180deg, rgba(0,0,0,.25), rgba(0,0,0,.12));
    border:1px solid var(--ring); border-radius:18px; padding:16px 18px;
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.04), 0 18px 60px rgba(0,0,0,.35);
  }
  .brand{ display:flex; gap:12px; align-items:center; }
  .logo{
    width:42px; height:42px; border-radius:12px; display:grid; place-items:center;
    background:conic-gradient(from 220deg, var(--accent), var(--accent2), var(--accent));
    box-shadow:0 0 36px rgba(0,194,199,.35);
  }
  .logo svg{ width:26px; height:26px; fill:#041418; }
  .title{ font-size:22px; font-weight:800; letter-spacing:.3px; }
  .subtitle{ font-size:13px; color:var(--muted); }

  .controls{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .in{
    background:var(--panel); border:1px solid var(--ring); color:var(--text);
    border-radius:12px; padding:10px 12px; min-width:220px;
  }
  .btn{
    background:var(--accent); color:#042022; border:none; border-radius:12px; padding:10px 14px;
    font-weight:800; cursor:pointer; box-shadow:0 6px 20px rgba(0,194,199,.22);
  }
  .btn.secondary{ background:transparent; color:var(--text); border:1px solid var(--ring); }

  /* FILTER BAR */
  .filters{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin:14px 2px; }
  .search{ flex:1; min-width:240px; }
  .toggle{ display:flex; gap:8px; align-items:center; color:var(--muted); font-size:14px; }
  .chk{ width:18px; height:18px; accent-color:var(--accent); }

  /* TABS + STATS */
  .tabs{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin:10px 2px 0 2px; }
  .tab{
    padding:8px 12px; border-radius:999px; border:1px solid var(--ring); cursor:pointer;
    color:var(--muted); font-weight:700; background:rgba(255,255,255,.02);
  }
  .tab.active{ color:#031b1c; background:var(--accent); border-color:transparent; }
  .pill{
    font-size:12px; opacity:.95; margin-left:6px; padding:2px 8px; border-radius:999px;
    background:rgba(0,0,0,.25); color:#031b1c;
  }

  .stats{ display:flex; gap:12px; flex-wrap:wrap; margin:10px 2px; color:var(--muted); }
  .stat{
    background:rgba(255,255,255,.04); border:1px solid var(--ring); border-radius:12px;
    padding:8px 10px;
  }
  .stat b{ color:var(--text); }

  /* PACKS AREA */
  .packsArea{
    margin:10px 2px;
    font-size:14px;
    color:var(--muted);
    display:flex;
    align-items:center;
    gap:10px;
  }
  #openPackBtn[disabled]{
    opacity:.4;
    cursor:not-allowed;
    box-shadow:none;
  }

  #lastPack{
    margin:10px 2px 0 2px;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid var(--ring);
    background:rgba(0,0,0,.35);
    font-size:13px;
  }
  #lastPack b{ color:var(--text); }
  #lastPack .cardLine{ margin-top:4px; }

  #packAnim{
  position:fixed;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  z-index:40;
  pointer-events:none;
}

.pack-anim-box{
  width:260px;
  height:360px;
  border-radius:18px;
  background:linear-gradient(135deg,#111827 0%,#312e81 40%,#7c3aed 70%,#fbbf24 100%);
  box-shadow:0 0 60px rgba(0,0,0,.8), 0 0 30px rgba(124,58,237,.8);
  position:relative;
  overflow:hidden;
  animation:pack-pop 600ms ease-out forwards;
}

.pack-anim-inner{
  position:absolute;
  inset:12px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.3);
  background:radial-gradient(circle at 20% 0%,rgba(255,255,255,.15),transparent 55%),
             radial-gradient(circle at 80% 100%,rgba(0,0,0,.4),rgba(0,0,0,.9));
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  text-align:center;
  color:#e5e7eb;
  font-family:Outfit,system-ui,sans-serif;
}

.pack-anim-title{
  font-size:20px;
  font-weight:800;
  letter-spacing:.08em;
  text-transform:uppercase;
  margin-bottom:6px;
}
.pack-anim-sub{
  font-size:13px;
  opacity:.85;
}

.pack-anim-shine{
  position:absolute;
  inset:-40%;
  background:linear-gradient(120deg,transparent 0%,rgba(255,255,255,.9) 40%,transparent 70%);
  transform:translateX(-100%);
  animation:pack-shine 900ms ease-out forwards 280ms;
  mix-blend-mode:screen;
}

@keyframes pack-pop{
  0%{ transform:scale(.3) rotate(-8deg); opacity:0; }
  60%{ transform:scale(1.05) rotate(2deg); opacity:1; }
  100%{ transform:scale(1) rotate(0deg); opacity:1; }
}

@keyframes pack-shine{
  0%{ transform:translateX(-100%); opacity:0; }
  30%{ opacity:1; }
  100%{ transform:translateX(100%); opacity:0; }
}


  /* GRID + CARD */
  .grid{
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
    gap:16px;
    margin-top:12px;
  }
  .card{
    position:relative; overflow:hidden; background:rgba(255,255,255,.04);
    border:1px solid var(--ring2); border-radius:16px; padding:14px;
    transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
    backdrop-filter: blur(3px);
  }
  .card:hover{
    transform:translateY(-2px);
    box-shadow:0 16px 50px rgba(0,0,0,.35);
    border-color:var(--ring);
  }
  .titleRow{ display:flex; justify-content:space-between; align-items:center; }
  .name{ font-weight:900; letter-spacing:.3px; }
  .rar{ font-size:12px; margin-left:6px; opacity:.9; }
  .img{
    width:100%; height:160px; object-fit:contain; border-radius:12px;
    background:#070b11; margin:12px 0;
    box-shadow:inset 0 0 0 1px rgba(255,255,255,.05);
  }
  .holo .img{ outline:2px dashed var(--c-legend); outline-offset:4px; }

  .desc{
    color:var(--muted);
    font-size:14px;
    min-height:22px;
    text-align:center;
    margin-top:6px;
    line-height:1.3;
    background:linear-gradient(90deg,#7dd3fc,#c084fc,#00C2C7);
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
    font-weight:600;
    filter:drop-shadow(0 0 6px rgba(0,194,199,0.25));
  }

  .meta{
    display:flex;
    justify-content:space-between;
    align-items:center;
    color:var(--muted);
    font-size:12px;
    margin-top:6px;
  }
  .play{
    margin-top:12px; width:100%; padding:10px 12px; border:none; border-radius:10px;
    font-weight:800; cursor:pointer; background:var(--accent); color:#031b1c;
  }
  .play[disabled]{ opacity:.45; cursor:not-allowed; }

  /* rarity colors */
  .common .name{ color:var(--c-common); }
  .rare   .name{ color:var(--c-rare); }
  .epic   .name{ color:var(--c-epic); }
  .legendary .name{ color:var(--c-legend); }

  /* SKELETON */
  .skeleton{
    background:rgba(255,255,255,.04);
    border:1px dashed var(--ring2);
    border-radius:16px;
    height:220px;
    animation:pulse 1.3s ease-in-out infinite;
  }
  @keyframes pulse{ 0%{opacity:.6} 50%{opacity:.85} 100%{opacity:.6} }

  /* TOAST */
  .toast{
    position:fixed; top:14px; left:50%; transform:translateX(-50%);
    background:#0f1722;
    border:1px solid var(--ring);
    border-radius:10px;
    padding:10px 14px;
    font-weight:800;
    z-index:9999;
    display:none;
  }

  /* notice */
  .notice{ color:var(--muted); margin:10px 2px; }
</style>
</head>
<body>
<div class="stars"></div>

<div class="wrap">
  <div class="hero">
    <div class="brand">
      <div class="logo">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M12 2l2.7 5.47 6.03.88-4.36 4.25 1.03 6.01L12 15.9l-5.4 2.71 1.03-6.01L3.27 8.35l6.03-.88L12 2z"/>
        </svg>
      </div>
      <div>
        <div class="title">Your Wonderland Cards</div>
        <div class="subtitle">See your inventory and play cards on stream</div>
      </div>
    </div>
    <div class="controls">
      <input id="uname" class="in" placeholder="Twitch name (e.g. momapix3l)"/>
      <input id="pin"   class="in" placeholder="PIN (if set)"/>
      <button id="save"    class="btn">Enter</button>
      <button id="refresh" class="btn secondary">Refresh</button>
    </div>
  </div>

  <div class="filters">
    <input id="search" class="in search" placeholder="Search cards…"/>
    <div class="toggle">
      <input id="onlyHolo" type="checkbox" class="chk"/>
      <label for="onlyHolo">Show holographics only ✨</label>
    </div>
  </div>

  <div id="notice" class="notice">Enter your Twitch name and press Enter.</div>

  <div class="tabs" id="tabs"></div>
  <div class="stats" id="stats"></div>

  <div id="packsArea" class="packsArea">
    You have <span id="packCount">0</span> unopened pack(s).
    <button id="openPackBtn" class="btn secondary" disabled>Open Pack</button>
  </div>

 <div id="lastPack" class="lastPack" style="display:none;"></div>

<!-- Pack open animation overlay -->
<div id="packAnim">
  <div class="pack-anim-box">
    <div class="pack-anim-inner">
      <div class="pack-anim-title">OPENING PACK</div>
      <div class="pack-anim-sub">Summoning your Wonderland cards…</div>
    </div>
    <div class="pack-anim-shine"></div>
  </div>
</div>

<div class="grid" id="grid">


  <div class="grid" id="grid">
    <div class="skeleton"></div>
    <div class="skeleton"></div>
    <div class="skeleton"></div>
  </div>
</div>

<div id="toast" class="toast">Toast</div>

<script>
/* ============== CONFIG ============== */
const API = 'https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLijQk2tugLIYCnzAhJYbcDymMXWRUSZVWXgODFZspYeSoq8mlZJcgv3l0LD9_bFrrdYDW9ZZAHZiX2BL1JKChvd2fYYyNAoBP1-n_uAVtwJ1oB6Ok0kILa5cSC60-2LXBb3EyboNO92dyoNomTyIMTDyFfeCzmC77VXl9BTjlSkLj2MY699UTTgpvwH6_FTRPVwy8-OMz7-H3W1ZbTOWYy0H4dun1D-ym5__srCzWzyMFBxgEZ7jHJp3G02PddlnFODmY80RFzE_in8WI6-KMcTgwgVHQ&lib=MSlVBSoo0rDa892bpIZLOKr7JIWNDQk7H'; // your /exec URL
const RARITIES = ['legendary','epic','rare','common'];
const RNAME = r => ({legendary:'Legendary',epic:'Epic',rare:'Rare',common:'Common'})[r] || r;
const RCOLOR= r => ({common:'var(--c-common)',rare:'var(--c-rare)',epic:'var(--c-epic)',legendary:'var(--c-legend)'})[r] || '#ccc';

/* ============== storage helpers ============== */
const getUser = () => (localStorage.getItem('tcr_user') || '').trim().toLowerCase();
const getPin  = () => (localStorage.getItem('tcr_pin')  || '').trim();
const setUser = u => localStorage.setItem('tcr_user',(u||'').trim().toLowerCase());
const setPin  = p => localStorage.setItem('tcr_pin',(p||'').trim());

/* JSONP helper (for Apps Script GET endpoints) */
function jsonp(url, params = {}) {
  return new Promise((resolve, reject) => {
    const cb = 'tcr_cb_' + Math.random().toString(36).slice(2);
    params.cb = cb;
    const qs = Object.entries(params)
      .map(([k,v]) => `${encodeURIComponent(k)}=${encodeURIComponent(v)}`)
      .join('&');
    const full = url + (url.includes('?') ? '&' : '?') + qs;

    const s = document.createElement('script');
    s.src = full;
    s.async = true;

    window[cb] = data => {
      try { resolve(data); } finally { delete window[cb]; s.remove(); }
    };
    s.onerror = () => {
      delete window[cb];
      s.remove();
      reject(new Error('JSONP load error'));
    };

    document.head.appendChild(s);
  });
}

/* ============== ui + state ============== */
const $ = id => document.getElementById(id);
const grid   = $('grid');
const tabs   = $('tabs');
const stats  = $('stats');
const notice = $('notice');
const search   = $('search');
const onlyHolo = $('onlyHolo');

let INVENTORY = [];
let ACTIVE    = 'all';
let timers    = [];
let SUM       = null;
let lastPackTimer = null;  // ⬅ for auto-hiding the last pack box


/* toast */
function toast(msg,ms=1800){
  const t = $('toast');
  t.textContent = msg;
  t.style.display = 'block';
  clearTimeout(toast._t);
  toast._t = setTimeout(() => t.style.display='none', ms);
}

/* tabs + stats */
function renderTabs(){
  tabs.innerHTML = '';
  tabs.appendChild(makeTab('all','All',null,true));
  RARITIES.forEach(r =>
    tabs.appendChild(makeTab(r, RNAME(r), SUM?.userCounts?.[r] || 0, false))
  );
  setActive(ACTIVE);
}
function makeTab(key,label,count,isFirst){
  const d = document.createElement('div');
  d.className = 'tab';
  d.dataset.key = key;
  if(isFirst) d.classList.add('active');
  d.innerHTML = label + (count != null ? `<span class="pill">${count}</span>` : '');
  d.onclick = () => { setActive(key); renderGrid(); };
  return d;
}
function setActive(key){
  ACTIVE = key;
  [...tabs.children].forEach(
    n => n.classList.toggle('active', n.dataset.key === key)
  );
}

function renderStats(){
  stats.innerHTML = '';
  if(!SUM) return;

  const box = (label,val,color) =>
    `<div class="stat"><span style="color:${color}">${label}:</span> <b>${val}</b></div>`;

  stats.innerHTML =
    box('Legendary', SUM.userCounts?.legendary || 0, RCOLOR('legendary')) +
    box('Epic',      SUM.userCounts?.epic      || 0, RCOLOR('epic'))      +
    box('Rare',      SUM.userCounts?.rare      || 0, RCOLOR('rare'))      +
    box('Common',    SUM.userCounts?.common    || 0, RCOLOR('common'))    +
    `<div class="stat">Catalog: <b>${SUM.totalCatalog || 0}</b></div>`;

  // Packs UI
  const packs    = SUM.packs || 0;
  const packSpan = $('packCount');
  const openBtn  = $('openPackBtn');
  if (packSpan) packSpan.textContent = packs;
  if (openBtn)  openBtn.disabled = packs <= 0;
}

/* grid */
function renderGrid(){
  timers.forEach(clearInterval);
  timers = [];

  const query = (search.value || '').trim().toLowerCase();
  const showHolo = !!onlyHolo.checked;

  const filtered = INVENTORY.filter(it => {
    if (ACTIVE !== 'all' && it.rarity !== ACTIVE) return false;
    if (showHolo && !String(it.cardId).endsWith(':holo')) return false;
    if (query && !(`${it.name} ${it.desc||''}`.toLowerCase().includes(query))) return false;
    return true;
  });

  grid.innerHTML = '';
  if (!filtered.length){
    grid.innerHTML = `<div class="notice">No cards match your filters.</div>`;
    return;
  }

  for(const it of filtered){
    const isHolo = String(it.cardId).endsWith(':holo');
    const card = document.createElement('div');
    card.className = `card ${it.rarity} ${isHolo ? 'holo' : ''}`;
    card.innerHTML = `
      <div class="titleRow">
        <div class="name">
          ${it.name}${isHolo ? ' ✨' : ''}
          <span class="rar" style="color:${RCOLOR(it.rarity)}">(${RNAME(it.rarity)})</span>
        </div>
      </div>
      ${it.imageUrl ? `<img class="img" src="${it.imageUrl}" alt="${it.name}"/>` : `<div class="img"></div>`}
      <div class="desc">${it.desc || ''}</div>
      <div class="meta">
        <div>Owned: <b>${it.qty}</b></div>
        <div class="cool" id="cool-${safeId(it.cardId)}">
          ${it.remain > 0 ? ('Cooldown: ' + fmt(it.remain)) : 'Ready'}
        </div>
      </div>
      <button class="play" ${it.remain>0 || it.qty<=0 ? 'disabled' : ''}>Play</button>
    `;
    const btn = card.querySelector('.play');
    btn.onclick = () => play(it.cardId);
    grid.appendChild(card);

    if(it.remain > 0){
      let left = it.remain;
      const label = card.querySelector(`#cool-${safeId(it.cardId)}`);
      const t = setInterval(() => {
        left = Math.max(0, left - 1);
        label.textContent = left > 0 ? ('Cooldown: ' + fmt(left)) : 'Ready';
        if(left === 0){
          btn.disabled = false;
          clearInterval(t);
        }
      }, 1000);
      timers.push(t);
    }
  }
}
const safeId = s => String(s).replace(/[^a-z0-9]/gi,'_');
const fmt    = s => {
  const m = Math.floor(s/60);
  const sec = s % 60;
  return (m ? m + 'm ' : '') + sec + 's';
};

/* network */
async function apiJSON(url,opts){
  const r = await fetch(url,opts);
  return r.json();
}

async function load(){
  const u = getUser();
  const p = getPin();

  if (!u){
    notice.textContent = 'Enter your Twitch name and press Enter.';
    grid.innerHTML = '';
    tabs.innerHTML = '';
    stats.innerHTML = '';
    return;
  }

  notice.textContent = 'Loading…';

const [inv,sum] = await Promise.all([
  apiJSON(`${API}?action=inventory&user=${encodeURIComponent(u)}&pin=${encodeURIComponent(p)}`),
  apiJSON(`${API}?action=summary&user=${encodeURIComponent(u)}&pin=${encodeURIComponent(p)}`)
]);
if(!inv.ok){
  if (inv.error && String(inv.error).indexOf('pin_required_or_invalid') !== -1){
    notice.textContent = 'PIN incorrect or missing. Use the !cardpin command on stream to get your PIN.';
  } else {
    notice.textContent = 'Error: ' + (inv.error || 'loading');
  }
  return;
}


  INVENTORY = inv.items || [];
  SUM       = sum || null;

  renderTabs();
  renderStats();
  renderGrid();
  notice.textContent = '';
}

async function play(cardId){
  const u = getUser();
  toast('Playing…', 1200);
  try{
    const res = await jsonp(API, { action:'redeem', user:u, cardId });
    if(res && res.ok){
      toast('Redeemed!');
      load();
    } else {
      toast('Error: ' + (res && res.error || 'failed'), 2400);
    }
  } catch(e){
    console.error(e);
    toast('Network error', 2400);
  }
}

async function openPack(){
  const u = getUser();
  if (!u){
    toast('Set your Twitch name first', 2200);
    return;
  }

  const btn     = $('openPackBtn');
  const animBox = $('packAnim');
  const lastBox = $('lastPack');

  // disable button while opening
  if (btn) btn.disabled = true;

  // clear any previous auto-hide
  if (lastPackTimer){
    clearTimeout(lastPackTimer);
    lastPackTimer = null;
  }

  // show pack animation
  if (animBox){
    animBox.style.display = 'flex';
  }
  toast('Opening pack…', 1200);

  try{
   const res = await jsonp(API, { action:'openpack', user:u, pin:getPin() });


    // wait a bit so the animation plays nicely
    await new Promise(r => setTimeout(r, 900));

    if (animBox){
      animBox.style.display = 'none';
    }

    if (!res || !res.ok){
      toast('Error: ' + (res && res.error || 'cannot open pack'), 2600);
    } else {
      // build result lines
      if (lastBox){
        const lines = (res.cards || []).map(c => {
          const rn   = RNAME(c.rarity);
          const holo = c.isHolo ? ' ✨' : '';
          return `<div class="cardLine">• <b>${c.baseId}</b>${holo} <span style="color:${RCOLOR(c.rarity)}">(${rn})</span></div>`;
        }).join('');
        lastBox.innerHTML = `<div><b>Last pack opened:</b></div>${lines || '<div class="cardLine">Empty pack?</div>'}`;
        lastBox.style.display = 'block';

        // auto-hide after 30 seconds
        lastPackTimer = setTimeout(() => {
          lastBox.style.display = 'none';
          lastBox.innerHTML = '';
        }, 30000);
      }

      // refresh inventory + stats + pack count
      await load();
    }
  } catch(e){
    console.error(e);
    if (animBox){
      animBox.style.display = 'none';
    }
    toast('Network error while opening pack', 2600);
  } finally {
    // button will be re-enabled/disabled by renderStats() via SUM.packs
  }
}


/* wire controls */
document.addEventListener('DOMContentLoaded', () => {
  $('uname').value = getUser();
  $('pin').value   = getPin();
  load();

  const btnOpen = $('openPackBtn');
  if (btnOpen) btnOpen.addEventListener('click', openPack);

  $('save').onclick = () => {
    const u = $('uname').value.trim();
    const p = $('pin').value.trim();

    if (!u || !p){
      toast('Enter your Twitch name AND PIN', 2200);
      return;
    }

    setUser(u);
    setPin(p);
    toast('Loading…');
    load();
  };

  $('refresh').onclick = () => load();
  $('search').addEventListener('input', () => renderGrid());
  $('onlyHolo').addEventListener('change', () => renderGrid());
});

</script>
</body>
</html>
